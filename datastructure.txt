# Role
You are an Expert Data Scientist specializing in Demographic Analysis and Matplotlib/Seaborn visualization.

# Task
Refactor the provided Python script to perform a "Migration Gap Analysis" using the Demographic Balancing Equation.
You must use **only** the specific valid datasets and ignore the misleading ones.

# 1. DATA CONTEXT & STRUCTURE

## File Structure (Wide Format)
* **Format**: Excel.
* **Columns**:
    * Column 0: `TIME` (This represents the **Reporting Country**).
    * Columns 1-N: Years (e.g., 2008, 2009... 2024).
* **Values**: Numeric counts. Missing data is marked with `:`.
* **Countries present in the data**: Denmark, Germany, Spain, France, Italy, Luxembourg, Netherlands, Norway, United Kingdom.

## ✅ FILES TO USE (The "Green List")
Use ONLY these files to build the balance equation ($S_t = S_{t-1} + I_t - E - N$):
1.  **Stock ($S_t$)**: `migr_resvalid.xlsx - Sheet 1.csv` (Valid Permits at year-end).
2.  **Inflow ($I_t$)**: `migr_resfirst.xlsx - Sheet 1.csv` (First Permits issued).
3.  **Naturalization ($N_t$)**: `migr_acq.xlsx - Sheet 1.csv` (Citizenship acquisition).
4.  **Official Emigration ($E_{off}$)**: `migr_emi1ctz.xlsx - Sheet 1.csv` (Reported emigration).

## ❌ FILES TO IGNORE (The "Red List")
**DO NOT USE**:
* `migr_imm.xlsx` (Total immigration - wrong scale/millions).
* `migr_pop1ctz.xlsx` (Census data - wrong methodology/dates).

# 2. METHODOLOGY: THE "GAP ANALYSIS"
Implement this specific logic for the **Top 10 countries** (by max Stock size).

## A. Core Metrics
1.  **Retention Rate ($R$)**: Calculate percentage of inflow that remains over a period.
2.  **Theoretical Stock ($S_{theo}$)**:
    * Hypothetical stock if *no one ever left or naturalized*.
    * Formula: $S_{theo, t} = S_{base} + \text{Cumulative Sum of } I_t$.
    * $S_{base}$ is the Stock at the first year where both Stock and Inflow data exist.
3.  **The Gap (Attrition)**:
    * $Gap_t = S_{theo, t} - S_{actual, t}$.
    * Represents "Silent Exit" + Naturalization + Official Emigration.

## B. Data Handling Rules
* **Dynamic Detection**: Read country names from Column 0. Do not hardcode the list, but expect the countries listed in the Context above.
* **Cleaning**: Vectorized replacement of `:` with `NaN`.
* **France Logic**: If `Emigration_Official` is missing/empty, treat it as 0 (rely on the derived Gap).
* **UK Logic**: Data ends around 2018 (Brexit). Do not plot zeros after the data ends; cut the plot at the last valid year.

# 3. VISUALIZATION REQUIREMENTS (Per Country)
For each analyzed country, generate a single figure with **2 stacked subplots**:

**Subplot 1: Dynamics (Stock vs Flow)**
* **Type**: Dual-Axis Combo Chart.
* **Left Axis (Bar)**: Inflow ($I_t$). Color: Light Red (`#ff9999`), Alpha: 0.6. Label: "New Permits ($I_t$)".
* **Right Axis (Line)**: Stock ($S_t$). Color: Dark Blue (`#003366`), Width: 2. Label: "Total Residents ($S_t$)".
* **Annotations**: Add vertical dashed lines for **2014** and **2022**.

**Subplot 2: The Gap Analysis**
* **Type**: Line Chart with Fill.
* **Line 1**: Actual Stock ($S_t$). Solid Blue.
* **Line 2**: Theoretical Stock ($S_{theo}$). Dashed Grey. Label: "Theoretical (No Exit)".
* **Fill**: Fill the area between Line 1 and Line 2 with Light Grey. Label: "Attrition (Departure/Citizenship)".

# 4. CODE INSTRUCTIONS
* Use `pandas` for calculation and `matplotlib`/`seaborn` for plotting.
* Keep the existing `load_and_process_file` function structure.
* Create a robust function to calculate the "Theoretical Stock" using `cumsum()`.
* Ensure the script outputs the plots and prints the Retention Rate ranking.